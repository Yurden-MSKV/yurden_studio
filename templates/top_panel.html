{% load static %}

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">

    <link rel="icon" href="{% static 'images/favicon.png' %}" type="image/x-icon">
    <link rel="shortcut icon" href="{% static 'images/favicon.png' %}" type="image/x-icon">

    <script>
    // Мгновенное применение темы до полной загрузки страницы
    (function() {
        function getInitialTheme() {
            try {
                const savedState = localStorage.getItem('themeState');
                if (savedState && ['auto', 'light', 'dark'].includes(savedState)) {
                    return savedState;
                }
            } catch (e) {
                // Игнорируем ошибки localStorage
            }
            return 'auto';
        }
        
        function applyInitialTheme() {
            const themeState = getInitialTheme();
            let actualTheme = 'light';
            
            if (themeState === 'auto') {
                const hour = new Date().getHours();
                actualTheme = (hour >= 19 || hour < 7) ? 'dark' : 'light';
            } else {
                actualTheme = themeState;
            }
            
            // Немедленно применяем класс к body
            document.body.classList.add(actualTheme + '-theme');
        }
        
        // Применяем тему как можно раньше
        if (document.body) {
            applyInitialTheme();
        } else {
            // Если body ещё не загружен, ждём его
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes) {
                        for (let i = 0; i < mutation.addedNodes.length; i++) {
                            if (mutation.addedNodes[i].tagName === 'BODY') {
                                applyInitialTheme();
                                observer.disconnect();
                                break;
                            }
                        }
                    }
                });
            });
            
            observer.observe(document.documentElement, { childList: true, subtree: true });
        }
    })();
    </script>
    
    {% block htmx_code %}

    {% endblock %}

    {% block title %}
        
    {% endblock %}
</head>
<body>
    {#  Контейнер всей страницы  #}
        {% block top_panel %}
            {% if request.is_mobile %}
                <link rel="stylesheet" href="{% static 'main_section/css/top_panel-mobile.css' %}">

                {#  Верхняя панель  #}
                <div class="top_panel_container">
                    <div class="site_name_container">
                        <h1>Студия Юрия Московцева</h1>
                    </div>
                    <div class="menu_toggle_block">
                        <button class="toggle_btn" onclick="toggleMenu()">
                            <img src="{% static 'main_section/icons/menu_icon.svg' %}">
                        </button>
                    </div>
                </div>
                <div class="menu-cont">
                        <div class="page-shadow" id="page-shadow"></div>
                        <div class="menu_block" id="menu_block">
                            <div class="navigation">
                                <a class="top_panel_button" href="{% url 'home-page' %}">
                                    <div class="button_block">
                                        Главная
                                    </div>
                                </a>
                                <a class="top_panel_button" href="{% url 'catalog-page' %}">
                                    <div class="button_block">
                                        Каталог
                                    </div>
                                </a>
                                <a class="top_panel_button" href="{% url 'post-catalog' %}">
                                    <div class="button_block">
                                        Посты
                                    </div>
                                </a>
                                <a class="top_panel_button" href="#">
                                    <div class="button_block">
                                        Работа
                                    </div>
                                </a>
                                <a class="top_panel_button" href="{% url 'info' %}">
                                    <div class="button_block">
                                        Инфо
                                    </div>
                                </a>
                            </div>
                            <div class="navigation" id="userMenu">
                                {% if user.username == 'yurden' %}
                                    <div class="menu_item">
                                        <a href="/admin/"><img src="{% static 'main_section/icons/admin.svg' %}">Админка</a>
                                    </div>
                                {% endif %}
                                <div class="menu_item">
                                    <button id="themeToggle" class="theme-toggle" aria-label="Переключить тему">
                                        <span class="theme-icon light-icon"><img src="{% static 'main_section/icons/light_mode.svg' %}"> Светлая</span>
                                        <span class="theme-icon dark-icon"><img src="{% static 'main_section/icons/dark_mode.svg' %}"> Тёмная</span>
                                        <span class="theme-icon auto-icon show"><img src="{% static 'main_section/icons/time_mode.svg' %}"> Авто</span>
                                    </button>
                                </div>
                                <div class="menu_item">
                                    <a href="{% url 'logout' %}"><img src="{% static 'main_section/icons/logout.svg' %}">Выйти</a>
                                </div>
                            </div>
                        </div>
                    </div>
{#                {% if user.is_authenticated %}#}
{#                    <div class="profile_menu" id="userMenu">#}
{#                        #}
{#                    </div>#}
{#                {% endif %}#}

                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        // Добавляем transition только после загрузки DOM
                        const menu = document.getElementById('menu_block');
                        const shadow = document.getElementById('page-shadow');
                        setTimeout(() => {
                            menu.style.transition = 'opacity 0.3s, visibility 0.3s';
                            shadow.style.transition = 'opacity 0.3s, visibility 0.3s';
                        }, 10);
                    });
                
                    function toggleMenu(event) {
                        if (event) event.stopPropagation();

                        const menu = document.getElementById('menu_block');
                        const shadow = document.getElementById('page-shadow');
                        const isShowing = !menu.classList.contains('show');

                        menu.classList.toggle('show');
                        shadow.classList.toggle('shadow_show');

                        if (isShowing) {
                            document.dispatchEvent(new CustomEvent('overlayShow', {detail: { isVisible: true }}));
                        } else {
                            document.dispatchEvent(new CustomEvent('overlayHide', {detail: { isVisible: false }}));
                        }
                    }

                    document.addEventListener('click', function(event) {
                        const menu = document.getElementById('menu_block');
                        const button = document.querySelector('.toggle_btn');

                        // Закрываем меню только если оно открыто И клик был вне меню И вне кнопки
                        if (menu.classList.contains('show') &&
                            !menu.contains(event.target) &&
                            !button.contains(event.target)) {

                            menu.classList.remove('show');
                            document.getElementById('page-shadow').classList.remove('shadow_show');
                            document.dispatchEvent(new CustomEvent('overlayHide', {detail: { isVisible: false }}));
                        }
                    });
                </script>
                <script>
                    // Обработчики для затемнения иконок при открытии меню
                    document.addEventListener('overlayShow', (event) => {
                      console.log('Overlay SHOW event received in top_panel');
                      document.querySelectorAll('.svg-icon').forEach(icon => {
                        icon.style.opacity = '0.5';
                      });
                    });
                    
                    document.addEventListener('overlayHide', (event) => {
                      console.log('Overlay HIDE event received in top_panel');
                      document.querySelectorAll('.svg-icon').forEach(icon => {
                        icon.style.opacity = '1';
                      });
                    });
                </script>

            {% else %}
                <link rel="stylesheet" href="{% static 'css/text.css' %}">
                <link rel="stylesheet" href="{% static 'css/themes.css' %}">
                <link rel="stylesheet" href="{% static 'main_section/css/top_panel.css' %}">
                

                {#  Верхняя панель  #}
                <div class="top_panel_container">
                    <div class="site_name_container">
                        <h2>Студия Юрия Московцева</h2>
                    </div>
                    <div class="buttons_container">
                        <a class="top_panel_button" href="{% url 'home-page' %}">
                            <div class="button_block">
                                <p>Главная</p>
                            </div>
                        </a>
                        <a class="top_panel_button" href="{% url 'catalog-page' %}">
                            <div class="button_block">
                                <p>Каталог</p>
                            </div>
                        </a>
                        <a class="top_panel_button" href="{% url 'post-catalog' %}">
                            <div class="button_block">
                                <p>Посты</p>
                            </div>
                        </a>
                        <a class="top_panel_button" href="#">
                            <div class="button_block">
                                <p>Работа</p>
                            </div>
                        </a>
                        <a class="top_panel_button" href="{% url 'info' %}">
                            <div class="button_block">
                                <p>Инфо</p>
                            </div>
                        </a>
                    </div>
                    <div class="profile_container">
                        {% if user.is_authenticated %}
                            <div class="profile_button_block">
                                <button class="profile_menu_btn" onclick="toggleMenu()">
                                    <img src="{% static "main_section/icons/profile_icon.svg" %}">
                                    <p>{{ user.username }}</p>
                                </button>
                            </div>
                        {% else %}
                            <div class="login">
                                <a href="{% url 'login' %}">Войти</a>
                            </div>
                            <p>|</p>
                            <div class="login">
                                <a href="{% url 'register' %}">Зарегистрироваться</a>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% if user.is_authenticated %}
                    <div class="profile_menu" id="userMenu">
                        {% if user.username == 'yurden' %}
                            <div class="menu_item">
                                <a href="/admin/"><img src="{% static 'main_section/icons/admin.svg' %}"><p>Админка</p></a>
                            </div>
                        {% endif %}
                        <div class="menu_item">
                            <button id="themeToggle" class="theme-toggle" aria-label="Переключить тему">
                                <span class="theme-icon light-icon"><img src="
{% static 'main_section/icons/light_mode.svg' %}"><p>Светлая</p></span>
                                <span class="theme-icon dark-icon"><img src="
{% static 'main_section/icons/dark_mode.svg' %}"><p>Тёмная</p></span>
                                <span class="theme-icon auto-icon show"><img src="
{% static 'main_section/icons/time_mode.svg' %}"><p>Авто</p></span>
                            </button>
                        </div>
                        <div class="menu_item">
                            <a href="{% url 'logout' %}"><img src="{% static 'main_section/icons/logout.svg' %}"><p>Выйти</p></a>
                        </div>
                    </div>
                {% endif %}

                <script>
                    function toggleMenu() {
                        const menu = document.getElementById('userMenu');
                        menu.classList.toggle('show');
                    }

                    document.addEventListener('click', function(event) {
                        const menu = document.getElementById('userMenu');
                        const button = document.querySelector('.profile_menu_btn');

                        if (!menu.contains(event.target) && !button.contains(event.target)) {
                            menu.classList.remove('show');
                        }
                    });
                </script>

            {% endif %}



        {% endblock %}

        {% block content %}

        {% endblock %}
    
    <script src="{% static 'js/theme.js' %}"></script>
    
{#<script src="{% static 'main_section/js/top_panel.js' %}"></script>#}

</body>
</html>