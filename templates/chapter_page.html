{% load static %}
{% load custom_filters %}


<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>{{ manga.manga_name }} - Глава {{ chapter.get_chapter_display }}</title>
    
    <link rel="icon" href="{% static 'images/favicon.png' %}" type="image/x-icon">
    <link rel="shortcut icon" href="{% static 'images/favicon.png' %}" type="image/x-icon">
    
</head>

<body>

{% if request.is_mobile %}

            <link rel="stylesheet" href="{% static 'manga_section/css/chapter_page-mobile.css' %}">
        <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js"></script>
        
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                htmx.config.useTemplateFragments = true;
                
                document.body.addEventListener('htmx:configRequest', function(evt) {
                    evt.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
                });
            });
        </script>
        
    {#    <div class="reader_selector">#}
    {#        <select onchange="changeReadingMode(this.value)">#}
    {#            <option value="rtl" {% if reading_mode == 'rtl' %} selected {% endif %}>По-японски</option>#}
    {#            <option value="vertical" {% if reading_mode == 'vertical' %} selected {% endif %}>Полотно</option>#}
    {#        </select>#}
    {#    </div>#}
    <div class="total_container">
        <div class="back_to_manga">
        <a href="{% url 'manga-page' slug=manga.manga_slug %}">
            <img src="{% static "manga_section/icons/arrow_back.svg" %}">
            <p>На страницу манги</p>
        </a>
        </div>
        
        <div class="main_container">
    
    {#        <div class="navigation">#}
    {#            <div class="manga_link">#}
    {#                <a href="{% url 'manga-page' slug=manga.manga_slug %}">#}
    {#                    <img src="{% static "manga_section/icons/arrow_back.svg" %}">#}
    {#                    На страницу манги#}
    {#                </a>#}
    {#            </div>#}
    {#            <div class="chapter_info">#}
    {#                <p>Глава {{ chapter.get_chapter_display }}</p>#}
    {#            </div>#}
    {#            <div class="navigate_buttons">#}
    {#                <button class="nav_arrow left_arrow" id="next-page" onclick="goToNextPage()">←</button>#}
    {#                <div class="page_bar" id="page-bar">#}
    {#                    <p id="current-pages">Страница 1</p>#}
    {#                </div>#}
    {#                <button class="nav_arrow right_arrow" id="prev-page" onclick="goToPreviousPage()">→</button>#}
    {#            </div>#}
    {#        </div>#}
    
            <div class="read_container" id="reader">
                <!-- Отображаем все пары страниц, но скрываем все кроме первой -->
                {% for pair in page_pairs %}
                    <div class="page-pair {% if forloop.first %}active{% else %}hidden{% endif %}"
                         data-pair-index="{{ forloop.counter0 }}">
                            <!-- Разворотная страница (занимает оба места) -->
                        <div class="spread-container">
                            <img src="{{ pair.page_image.url }}"
                                 class="page spread-page"
                                 data-page-number="{{ pair.0.page_number }}"
                                 alt="Страница {{ pair.0.page_number }}">
                        </div>
                        <div class="reader_buttons">
                            <div class="toggle_next read_btn">
                                <button id="next_page" onclick="goToNextPage()"></button>
                            </div>            
                            <div class="toggle_prev read_btn">
                                <button id="prev_page" onclick="goToPreviousPage()"></button>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        
        </div>
    
{#        <div class="side_bar">#}
{#                <div class="current_ch">#}
{#                    <p>Глава {{ chapter.get_chapter_display }}</p>#}
{#                </div>#}
{#                <div class="credits">#}
{#                    {% if chapter.interpreter.all %}#}
{#                        <h1>Переводчик:</h1>#}
{#                        {% for person in chapter.interpreter.all %}#}
{#                            <a href="{{ person.link_for_offers }}"><h2>{{ person.staff_name }}</h2></a>{% if not forloop.last %}, {% endif %}#}
{#                        {% endfor %}#}
{#                    {% endif %}#}
{#                    {% if chapter.editor.all %}#}
{#                        <h1>Редактор:</h1>#}
{#                        {% for person in chapter.editor.all %}#}
{#                            <a href="{{ person.link_for_offers }}"><h2>{{ person.staff_name }}</h2></a>{% if not forloop.last %}, {% endif %}#}
{#                        {% endfor %}#}
{#                    {% endif %}#}
{#                    {% if chapter.retoucher.all %}#}
{#                        <h1>Ретушёр:</h1>#}
{#                        {% for person in chapter.retoucher.all %}#}
{#                            <a href="{{ person.link_for_offers }}"><h2>{{ person.staff_name }}</h2></a>{% if not forloop.last %}, {% endif %}#}
{#                        {% endfor %}#}
{#                    {% endif %}#}
{#                    {% if chapter.typesetter.all %}#}
{#                        <h1>Верстальщик:</h1>#}
{#                        {% for person in chapter.typesetter.all %}#}
{#                            <a href="{{ person.link_for_offers }}"><h2>{{ person.staff_name }}</h2></a>{% if not forloop.last %}, {% endif %}#}
{#                        {% endfor %}#}
{#                    {% endif %}#}
{#                    {% if chapter.sfx_artist.all %}#}
{#                        <h1>Художник по звукам:</h1>#}
{#                        {% for person in chapter.sfx_artist.all %}#}
{#                            <a href="{{ person.link_for_offers }}"><h2>{{ person.staff_name }}</h2></a>{% if not forloop.last %}, {% endif %}#}
{#                        {% endfor %}#}
{#                    {% endif %}#}
{#                </div>#}
{#    #}
{#                <!-- Включаем partial напрямую -->#}
{#                {% include 'partials/rating_block.html' with manga=manga chapter=chapter like_percentage=like_percentage user_rating=user_rating %}#}
{#        </div>#}
    
    </div>
            <!-- JavaScript для управления навигацией -->
        <script>
            let currentPairIndex = 0;
            const totalPairs = {{ page_pairs|length }};
            const manga_slug = "{{ manga.manga_slug }}";
            const next_chapter = {% if next_chapter %}"{{ next_chapter }}"{% else %}null{% endif %};
            const prev_chapter = {% if prev_chapter %}"{{ prev_chapter }}"{% else %}null{% endif %};
            const mobilepagePairs = document.querySelectorAll('.page-pair');
    
            // Функция для обновления отображаемой пары страниц
            function updateDisplayedPair() {
                // Скрываем все пары
                mobilepagePairs.forEach(pair => {
                    pair.classList.add('hidden');
                    pair.classList.remove('active');
                });
    
                // Показываем текущую пару
                mobilepagePairs[currentPairIndex].classList.remove('hidden');
                mobilepagePairs[currentPairIndex].classList.add('active');
    
                // Обновляем информацию о текущих страницах
                {#updatePageInfo();#}
            }
    
            // Функция для обновления информации о страницах
            function updatePageInfo() {
                const currentPair = mobilepagePairs[currentPairIndex];
                const pages = currentPair.querySelectorAll('.page[data-page-number]');
    
                if (pages.length === 1) {
                    // Для разворотной страницы
                    document.getElementById('current-pages').textContent =
                        `Страница ${pages[0].dataset.pageNumber}`;
                } else if (pages.length === 2) {
                    // Для двух страниц
                    document.getElementById('current-pages').textContent =
                        `Страницы ${pages[0].dataset.pageNumber}—${pages[1].dataset.pageNumber}`;
                } else if (pages.length === 1 && currentPair.querySelector('.empty')) {
                    // Для одиночной страницы с пустым местом
                    document.getElementById('current-pages').textContent =
                        `Страница ${pages[0].dataset.pageNumber}`;
                }
            }
    
            // Переход к следующей паре страниц
            function goToNextPage() {
                if (currentPairIndex < totalPairs - 1) {
                    currentPairIndex++;
                    updateDisplayedPair();
                } 
                else if (currentPairIndex === totalPairs - 1 && next_chapter) {
                    window.location.href = `/manga/${manga_slug}/chapter/${next_chapter}/`;
                }
                else if (currentPairIndex === totalPairs - 1 && !next_chapter) {
                    window.location.href = `/manga/${manga_slug}/`;
                }
            }
    
            // Переход к предыдущей паре страниц
            function goToPreviousPage() {
                if (currentPairIndex > 0) {
                    currentPairIndex--;
                    updateDisplayedPair();
                } 
                else if (currentPairIndex === 0 && prev_chapter) {
                    window.location.href = `/manga/${manga_slug}/chapter/${prev_chapter}/`;
                }
                else if (currentPairIndex === 0 && !prev_chapter) {
                    window.location.href = `/manga/${manga_slug}/`;
                }
            }
    
            // Инициализация при загрузке
            updateDisplayedPair();
        </script>
    
{% else %}
    
        <link rel="stylesheet" href="{% static 'manga_section/css/chapter_page.css' %}">
        <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js"></script>
        
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                htmx.config.useTemplateFragments = true;
                
                document.body.addEventListener('htmx:configRequest', function(evt) {
                    evt.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
                });
            });
        </script>
        
    {#    <div class="reader_selector">#}
    {#        <select onchange="changeReadingMode(this.value)">#}
    {#            <option value="rtl" {% if reading_mode == 'rtl' %} selected {% endif %}>По-японски</option>#}
    {#            <option value="vertical" {% if reading_mode == 'vertical' %} selected {% endif %}>Полотно</option>#}
    {#        </select>#}
    {#    </div>#}
    <div class="total_container">
        <div class="back_to_manga">
        <a href="{% url 'manga-page' slug=manga.manga_slug %}">
            <img src="{% static "manga_section/icons/arrow_back.svg" %}">
            На страницу манги
        </a>
        </div>
        
        <div class="main_container">
    
    {#        <div class="navigation">#}
    {#            <div class="manga_link">#}
    {#                <a href="{% url 'manga-page' slug=manga.manga_slug %}">#}
    {#                    <img src="{% static "manga_section/icons/arrow_back.svg" %}">#}
    {#                    На страницу манги#}
    {#                </a>#}
    {#            </div>#}
    {#            <div class="chapter_info">#}
    {#                <p>Глава {{ chapter.get_chapter_display }}</p>#}
    {#            </div>#}
    {#            <div class="navigate_buttons">#}
    {#                <button class="nav_arrow left_arrow" id="next-page" onclick="goToNextPage()">←</button>#}
    {#                <div class="page_bar" id="page-bar">#}
    {#                    <p id="current-pages">Страница 1</p>#}
    {#                </div>#}
    {#                <button class="nav_arrow right_arrow" id="prev-page" onclick="goToPreviousPage()">→</button>#}
    {#            </div>#}
    {#        </div>#}
    
            <div class="read_container" id="reader">
                <!-- Отображаем все пары страниц, но скрываем все кроме первой -->
                {% for pair in page_pairs %}
                    <div class="page-pair {% if forloop.first %}active{% else %}hidden{% endif %}"
                         data-pair-index="{{ forloop.counter0 }}">
    
                        {% if pair|length == 1 and pair.0.is_double_page %}
                            <!-- Разворотная страница (занимает оба места) -->
                            <div class="spread-container">
                                <img src="{{ pair.0.page_image.url }}"
                                     class="page spread-page"
                                     data-page-number="{{ pair.0.page_number }}"
                                     alt="Страница {{ pair.0.page_number }}">
                            </div>
                        {% elif pair|length == 2 %}
                            <!-- Две обычные страницы -->
                            <div class="page-container left-page">
                                <img src="{{ pair.1.page_image.url }}"
                                     class="page normal-page"
                                     data-page-number="{{ pair.1.page_number }}"
                                     alt="Страница {{ pair.1.page_number }}">
                            </div>
                            <div class="page-container right-page">
                                <img src="{{ pair.0.page_image.url }}"
                                     class="page normal-page"
                                     data-page-number="{{ pair.0.page_number }}"
                                     alt="Страница {{ pair.0.page_number }}">
                            </div>
                        {% else %}
                            <!-- Одиночная страница (последняя непарная) -->
                            <div class="spread-container">
                                <img src="{{ pair.0.page_image.url }}"
                                     class="page normal-page"
                                     data-page-number="{{ pair.0.page_number }}"
                                     alt="Страница {{ pair.0.page_number }}">
                            </div>
                        {% endif %}
                        <div class="reader_buttons">
                            <div class="toggle_next read_btn">
                                <button id="next_page" onclick="goToNextPage()"></button>
                            </div>            
                            <div class="toggle_prev read_btn">
                                <button id="prev_page" onclick="goToPreviousPage()"></button>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        
        </div>
    
        <div class="side_bar">
                <div class="current_ch">
                    <p>Глава {{ chapter.get_chapter_display }}</p>
                </div>
                <div class="credits">
                    {% if chapter.interpreter.all %}
                        <h1>Переводчик:</h1>
                        {% for person in chapter.interpreter.all %}
                            <a href="{{ person.link_for_offers }}"><h2>{{ person.staff_name }}</h2></a>{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    {% endif %}
                    {% if chapter.editor.all %}
                        <h1>Редактор:</h1>
                        {% for person in chapter.editor.all %}
                            <a href="{{ person.link_for_offers }}"><h2>{{ person.staff_name }}</h2></a>{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    {% endif %}
                    {% if chapter.retoucher.all %}
                        <h1>Ретушёр:</h1>
                        {% for person in chapter.retoucher.all %}
                            <a href="{{ person.link_for_offers }}"><h2>{{ person.staff_name }}</h2></a>{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    {% endif %}
                    {% if chapter.typesetter.all %}
                        <h1>Верстальщик:</h1>
                        {% for person in chapter.typesetter.all %}
                            <a href="{{ person.link_for_offers }}"><h2>{{ person.staff_name }}</h2></a>{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    {% endif %}
                    {% if chapter.sfx_artist.all %}
                        <h1>Художник по звукам:</h1>
                        {% for person in chapter.sfx_artist.all %}
                            <a href="{{ person.link_for_offers }}"><h2>{{ person.staff_name }}</h2></a>{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
    
                <!-- Включаем partial напрямую -->
                {% include 'partials/rating_block.html' with manga=manga chapter=chapter like_percentage=like_percentage user_rating=user_rating %}
    
            </div>
    </div>
            <!-- JavaScript для управления навигацией -->
        <script>
            let currentPairIndex = 0;
            const totalPairs = {{ page_pairs|length }};
            const manga_slug = "{{ manga.manga_slug }}";
            const next_chapter = {% if next_chapter %}"{{ next_chapter }}"{% else %}null{% endif %};
            const prev_chapter = {% if prev_chapter %}"{{ prev_chapter }}"{% else %}null{% endif %};
            const pagePairs = document.querySelectorAll('.page-pair');
    
            // Функция для обновления отображаемой пары страниц
            function updateDisplayedPair() {
                // Скрываем все пары
                pagePairs.forEach(pair => {
                    pair.classList.add('hidden');
                    pair.classList.remove('active');
                });
    
                // Показываем текущую пару
                pagePairs[currentPairIndex].classList.remove('hidden');
                pagePairs[currentPairIndex].classList.add('active');
    
                // Обновляем информацию о текущих страницах
                {#updatePageInfo();#}
            }
    
            // Функция для обновления информации о страницах
            function updatePageInfo() {
                const currentPair = pagePairs[currentPairIndex];
                const pages = currentPair.querySelectorAll('.page[data-page-number]');
    
                if (pages.length === 1) {
                    // Для разворотной страницы
                    document.getElementById('current-pages').textContent =
                        `Страница ${pages[0].dataset.pageNumber}`;
                } else if (pages.length === 2) {
                    // Для двух страниц
                    document.getElementById('current-pages').textContent =
                        `Страницы ${pages[0].dataset.pageNumber}—${pages[1].dataset.pageNumber}`;
                } else if (pages.length === 1 && currentPair.querySelector('.empty')) {
                    // Для одиночной страницы с пустым местом
                    document.getElementById('current-pages').textContent =
                        `Страница ${pages[0].dataset.pageNumber}`;
                }
            }
    
            // Переход к следующей паре страниц
            function goToNextPage() {
                if (currentPairIndex < totalPairs - 1) {
                    currentPairIndex++;
                    updateDisplayedPair();
                } 
                else if (currentPairIndex === totalPairs - 1 && next_chapter) {
                    window.location.href = `/manga/${manga_slug}/chapter/${next_chapter}/`;
                }
                else if (currentPairIndex === totalPairs - 1 && !next_chapter) {
                    window.location.href = `/manga/${manga_slug}/`;
                }
            }
    
            // Переход к предыдущей паре страниц
            function goToPreviousPage() {
                if (currentPairIndex > 0) {
                    currentPairIndex--;
                    updateDisplayedPair();
                } 
                else if (currentPairIndex === 0 && prev_chapter) {
                    window.location.href = `/manga/${manga_slug}/chapter/${prev_chapter}/`;
                }
                else if (currentPairIndex === 0 && !prev_chapter) {
                    window.location.href = `/manga/${manga_slug}/`;
                }
            }
    
            // Обработка клавиш клавиатуры для навигации
            document.addEventListener('keydown', function(event) {
                if (event.key === 'ArrowRight') {
                    goToPreviousPage();
                } else if (event.key === 'ArrowLeft') {
                    goToNextPage();
                }
            });
    
            // Инициализация при загрузке
            updateDisplayedPair();
        </script>
    
{% endif %}


    
    <script src="{% static 'js/theme.js' %}"></script>

</body>
</html>