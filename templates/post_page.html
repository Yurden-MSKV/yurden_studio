{% extends 'top_panel.html' %}
{% load static %}

{% block title %}
    <title>{{ post.post_name }}</title>
{% endblock %}

{% block content %}

    <link rel="stylesheet" href="{% static 'post_section/css/post_page.css' %}">
    <div class="main_container">
        <div class="post_container">
            {% if post.post_slug != 'info' %}
                <div class="post_header">
                    <div class="post_title">
                        <h1>{{ post.post_name }}</h1>
                    </div>
                    <div class="post_views">
                        <img src="{% static 'post_section/icons/view_eye.svg' %}">
                        <p>{{ post.view_count }}</p>
                    </div>
                </div>
            {% endif %}
            
            <div class="post_content">
                <p>{{ post.content|safe }}</p>
                
                <!-- Блок опроса будет рендериться только если poll существует -->
                {% if poll %}
                    <div id="poll-container" class="poll-container">
                        <h2>{{ poll.question }}</h2>

                        <!-- Предупреждение для неавторизованных -->
                        {% if not user.is_authenticated %}
                        <div class="auth-warning">
                            ⚠️ Для голосования необходимо <a href="/admin/login/">войти в систему</a>
                        </div>
                        {% endif %}

                        <!-- Блок с кнопками голосования -->
                        <div id="vote-buttons" class="vote-buttons"
                             {% if user_vote %}style="display: none;"{% endif %}>
                            {% for choice in choices %}
                            <button type="button" class="vote-btn" data-choice-id="{{ choice.id }}"
                                    {% if not user.is_authenticated %}disabled{% endif %}>
                                {{ choice.choice_text }}
                            </button>
                            {% endfor %}
                        </div>

                        <!-- Блок для результатов -->
                        <div id="results" class="results" {% if not user_vote %}style="display: none;"{% endif %}>
                            {% if user_vote or results_data.total_votes > 0 %}
                                <!-- Показываем статические результаты при первой загрузке -->
                                <div class="static-results">
                                    {% for result in results_data.results %}
                                    <div class="result-item">
                                        <div class="result-text">
                                            <span>{{ result.choice_text }}
                                                {% if user_vote and user_vote.choice.id == result.choice_id %} [твой выбор]{% endif %}</span>
                                            <span>Голосов: {{ result.vote_count }}</span>
                                        </div>
                                        <div class="result-block">
                                            <div class="result-bar">
                                                <div class="result-fill {% if user_vote and user_vote.choice.id == result.choice_id %}user-vote-fill{% endif %} {% if result.percentage == 0 %}zero-percent{% endif %}"
                                                     {% if result.percentage > 0 %}style="width: {{ result.percentage }}%"{% endif %}>
                                                </div>
                                            </div>
                                            <div class="result-percent">
                                                {{ result.percentage }}%
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}

                                    {% if user_vote %}
                                        <button type="button" class="cancel-btn" onclick="cancelVote()">
                                            ✖ Отменить мой голос
                                        </button>
                                    {% endif %}
                                </div>
                            {% else %}
                                <p>Пока нет голосов. Будьте первым!</p>
                            {% endif %}
                        </div>
                    </div>

                    <script src="{% static 'post_section/js/poll.js' %}"></script>
                    <script>
                        // Инициализируем опрос только если он есть на странице
                        window.userVoted = {% if user_vote %}true{% else %}false{% endif %};
                        window.userChoiceId = {% if user_vote %}{{ user_vote.choice.id }}{% else %}null{% endif %};
                        
                        document.addEventListener('DOMContentLoaded', function() {
                            if (document.getElementById('poll-container')) {
                                initializePoll();
                            }
                        });

                        function initializePoll() {
                            console.log('Poll JS загружен', { 
                                userVoted: window.userVoted, 
                                userChoiceId: window.userChoiceId 
                            });

                            // Сохраняем оригинальные тексты кнопок
                            document.querySelectorAll('.vote-btn').forEach(button => {
                                button.setAttribute('data-original-text', button.textContent);

                                // Назначаем обработчики клика
                                button.addEventListener('click', function() {
                                    if (!this.disabled) {
                                        const choiceId = this.getAttribute('data-choice-id');
                                        console.log('Клик по кнопке:', choiceId);
                                        vote(parseInt(choiceId));
                                    }
                                });
                            });

                            // Убедимся, что кнопка отмены в правильном состоянии при загрузке
                            resetCancelButton();
                        }
                    </script>
                {% endif %}
                <!-- Конец блока опроса -->

            </div>
        </div>
    </div>

    {% if user.username == 'yurden' %}
        <div class="side_bar">
            <div class="menu_block">
                <a href="/admin/post_section/post/{{ post.id }}/change/"><p>Редактировать</p><img src="{% static 'post_section/icons/edit.svg' %}"></a>
            </div>
        </div>
    {% endif %}

{% endblock %}